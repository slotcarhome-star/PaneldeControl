<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KronoMaster - Control Total</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #0f172a; font-family: system-ui, -apple-system, sans-serif; color: #e2e8f0; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .nav-btn { @apply px-4 py-2 rounded-lg text-sm font-bold text-slate-400 border border-slate-700 transition-all flex items-center gap-2 hover:bg-slate-800 hover:text-white whitespace-nowrap; }
        .nav-btn.active { @apply text-white border-transparent shadow-lg transform scale-105; }
        
        .nav-btn.active[data-color="blue"] { background-color: #2563eb; }
        .nav-btn.active[data-color="emerald"] { background-color: #059669; }
        .nav-btn.active[data-color="orange"] { background-color: #ea580c; }
    </style>
</head>
<body class="min-h-screen pb-20 selection:bg-indigo-500 selection:text-white">

    <!-- CABECERA -->
    <header class="bg-slate-900/95 backdrop-blur-md border-b border-slate-800 p-4 sticky top-0 z-50 shadow-2xl">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-tr from-indigo-600 to-violet-600 p-2.5 rounded-xl shadow-lg">
                    <i class="fas fa-network-wired text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">Krono<span class="text-indigo-400">Master</span></h1>
                    <div class="flex items-center gap-2">
                        <span id="connection-status" class="relative flex h-2 w-2">
                          <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                        </span>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">DB: correo-95e58</p>
                    </div>
                </div>
            </div>

            <div class="flex bg-slate-800/50 p-1.5 rounded-xl border border-slate-700/50 w-full md:w-auto overflow-x-auto gap-2 backdrop-blur-sm">
                <button onclick="switchApp(0)" id="btn-app-0" class="nav-btn active" data-color="blue">
                    <i class="fas fa-stopwatch"></i> KronoPersonal <span class="bg-black/20 px-1.5 rounded text-[10px] opacity-70">2€</span>
                </button>
                <button onclick="switchApp(1)" id="btn-app-1" class="nav-btn" data-color="emerald">
                    <i class="fas fa-road"></i> KronoDual <span class="bg-black/20 px-1.5 rounded text-[10px] opacity-70">5€</span>
                </button>
                <button onclick="switchApp(2)" id="btn-app-2" class="nav-btn" data-color="orange">
                    <i class="fas fa-tachometer-alt"></i> TRACKS & TELEMETRY <span class="bg-black/20 px-1.5 rounded text-[10px] opacity-70">15€</span>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto p-4 md:p-8">
        
        <!-- CAJA DE ERRORES INTELIGENTE -->
        <div id="error-box" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-6 rounded-xl mb-6 shadow-xl">
            <h3 class="text-lg font-bold text-red-100 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i> ERROR DE CONFIGURACIÓN</h3>
            <p id="error-msg" class="font-mono text-sm mb-4">...</p>
            <div id="error-solution" class="bg-black/30 p-4 rounded text-sm text-slate-300"></div>
        </div>

        <!-- PANEL DE CONTROL -->
        <div id="main-panel" class="fade-in space-y-8">
            <div class="flex flex-col md:flex-row justify-between items-end border-b border-slate-800 pb-6 gap-4">
                <div>
                    <div class="flex items-center gap-3 mb-2">
                        <h2 id="current-app-name" class="text-4xl font-bold text-white tracking-tight">Iniciando...</h2>
                        <span id="current-app-badge" class="px-2 py-1 rounded text-xs font-bold uppercase bg-slate-800 text-slate-400">APP ACTIVA</span>
                    </div>
                    <p class="text-sm text-slate-400 font-mono flex items-center gap-2">
                        <i class="fas fa-folder-open text-slate-600"></i> ID: <span id="current-app-id" class="text-white font-bold bg-slate-800 px-2 rounded">...</span>
                    </p>
                </div>
                <div class="flex gap-4">
                    <div class="text-right px-4 border-r border-slate-800">
                        <div class="text-2xl font-bold text-white" id="stat-leads">0</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase">Pendientes</div>
                    </div>
                    <div class="text-right px-2">
                        <div class="text-2xl font-bold text-white" id="stat-licenses">0</div>
                        <div class="text-[10px] text-slate-500 font-bold uppercase">Activos</div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 md:gap-6">
                <button onclick="setInternalTab('work')" id="int-tab-work" class="relative overflow-hidden p-6 rounded-2xl text-left border transition-all duration-300 group">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 group-hover:opacity-20 transition-all duration-500">
                        <i class="fas fa-envelope-open-text text-7xl"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-bold opacity-70 mb-1">GESTIÓN DE CORREOS</p>
                        <h3 class="text-xl md:text-2xl font-bold">Pedidos Pendientes</h3>
                    </div>
                </button>

                <button onclick="setInternalTab('data')" id="int-tab-data" class="relative overflow-hidden p-6 rounded-2xl text-left border transition-all duration-300 group bg-slate-800 border-slate-700 text-slate-400 hover:bg-slate-750 hover:text-white">
                    <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:scale-110 group-hover:opacity-20 transition-all duration-500">
                        <i class="fas fa-database text-7xl"></i>
                    </div>
                    <div class="relative z-10">
                        <p class="text-sm font-bold opacity-70 mb-1">BASE DE DATOS</p>
                        <h3 class="text-xl md:text-2xl font-bold">Licencias Activas</h3>
                    </div>
                </button>
            </div>

            <div id="view-work" class="space-y-6 fade-in">
                <div class="bg-slate-800 border-l-4 p-6 rounded-r-xl shadow-xl flex flex-col md:flex-row gap-4 items-end transition-colors" id="box-new-lead">
                    <div class="flex-1 w-full">
                        <label class="text-xs font-bold uppercase mb-2 block flex items-center gap-2" id="lbl-new-lead">
                           <i class="fas fa-plus-circle"></i> Registrar Nuevo Interesado Manualmente
                        </label>
                        <div class="relative">
                            <i class="fas fa-envelope absolute left-3 top-3.5 text-slate-500"></i>
                            <input type="email" id="input-email" placeholder="cliente@ejemplo.com" 
                                class="w-full bg-slate-900 border border-slate-600 rounded-lg py-3 pl-10 pr-4 text-white focus:border-white focus:ring-0 outline-none transition-colors">
                        </div>
                    </div>
                    <button onclick="addLead()" id="btn-save-lead" class="w-full md:w-auto font-bold py-3 px-8 rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform text-white">
                        GUARDAR
                    </button>
                </div>
                <div id="leads-container" class="space-y-4 min-h-[200px]"></div>
            </div>

            <div id="view-data" class="hidden space-y-6 fade-in">
                <div class="bg-emerald-900/10 border border-emerald-500/20 p-4 rounded-xl flex items-start gap-4">
                    <div class="p-3 bg-emerald-500/10 rounded-lg text-emerald-500">
                        <i class="fas fa-check-circle text-2xl"></i>
                    </div>
                    <div>
                        <h4 class="text-emerald-400 font-bold text-sm uppercase">Licencias en Vigor</h4>
                        <p class="text-sm text-slate-400 mt-1">Lista real de accesos permitidos. Borrar aquí elimina el acceso.</p>
                    </div>
                </div>
                <div id="licenses-container" class="space-y-3 bg-slate-800/50 p-4 rounded-xl border border-slate-700/50 shadow-inner min-h-[200px]"></div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDW-2Yc4kvZJYbNOVeesPZWdRThYe0noUI",
            authDomain: "correo-95e58.firebaseapp.com",
            projectId: "correo-95e58",
            storageBucket: "correo-95e58.firebasestorage.app",
            messagingSenderId: "977860532946",
            appId: "1:977860532946:web:3738c6b7165201bce7ab0b",
            measurementId: "G-6DMG51VQ92"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // CONFIGURACIÓN DE APPS
        const apps = [
            { 
                name: "KronoPersonal", 
                id: "app_krono", 
                price: "Consultar", 
                color: "blue", 
                colorHex: "#2563eb"
            },
            { 
                name: "KronoDual", 
                id: "app_kronodual", 
                price: "5€", 
                color: "emerald", 
                colorHex: "#059669"
            },
            { 
                name: "TRACKS & TELEMETRY", 
                id: "app_tracks", 
                price: "15€", 
                color: "orange", 
                colorHex: "#ea580c"
            }
        ];

        let currentAppIndex = 0;
        let leads = [];
        let licenses = [];
        let unsubLeads = null;
        let unsubLicenses = null;

        // INICIO SEGURO
        window.onload = async () => {
            try {
                console.log("Intentando conectar...");
                await signInAnonymously(auth);
                
                // Indicador visual de conexión OK
                const statusDot = document.getElementById('connection-status');
                if(statusDot) statusDot.innerHTML = '<span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>';
                
                // Cargar App 0
                switchApp(0);
            } catch (error) {
                console.error("Error Auth:", error);
                const box = document.getElementById('error-box');
                const msg = document.getElementById('error-msg');
                const sol = document.getElementById('error-solution');
                
                box.classList.remove('hidden');
                msg.innerText = error.message;

                if (error.code === 'auth/configuration-not-found' || error.code === 'auth/admin-restricted-operation') {
                    sol.innerHTML = `
                    <p class="font-bold text-yellow-400 mb-2">SOLUCIÓN REQUERIDA EN FIREBASE:</p>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li>Ve a la Consola de Firebase > <strong>Authentication</strong>.</li>
                        <li>Pestaña <strong>Sign-in method</strong>.</li>
                        <li>Activa el proveedor <strong>Anónimo</strong>.</li>
                    </ol>`;
                } else {
                    sol.innerText = "Revisa tu conexión a internet y la configuración de Firebase.";
                }
            }
        };

        window.switchApp = (idx) => {
            currentAppIndex = idx;
            const currentApp = apps[idx];

            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                if(i === idx) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            const titleEl = document.getElementById('current-app-name');
            if(titleEl) {
                titleEl.innerText = currentApp.name;
                titleEl.className = `text-4xl font-bold tracking-tight mb-1 text-${currentApp.color}-400`;
            }
            
            const idEl = document.getElementById('current-app-id');
            if(idEl) idEl.innerText = currentApp.id;
            
            updateInternalTabStyles('work');
            loadData(currentApp.id);
        };

        function loadData(appId) {
            const leadsCont = document.getElementById('leads-container');
            const licCont = document.getElementById('licenses-container');

            if(leadsCont) leadsCont.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-circle-notch fa-spin"></i> Cargando datos...</div>';
            if(licCont) licCont.innerHTML = '<div class="text-center py-10 opacity-50"><i class="fas fa-circle-notch fa-spin"></i> Cargando datos...</div>';
            
            if(unsubLeads) unsubLeads();
            if(unsubLicenses) unsubLicenses();

            try {
                // Cargar Leads
                const q1 = query(collection(db, 'artifacts', appId, 'public', 'data', 'krono_leads'));
                unsubLeads = onSnapshot(q1, s => {
                    leads = s.docs.map(d => ({id:d.id, ...d.data()}));
                    leads.sort((a,b)=>(b.createdAt||'').localeCompare(a.createdAt||''));
                    
                    document.getElementById('stat-leads').innerText = leads.length;
                    renderLeads();
                }, err => showDBError(err, leadsCont));

                // Cargar Licencias
                const q2 = query(collection(db, 'artifacts', appId, 'public', 'data', 'access_codes'));
                unsubLicenses = onSnapshot(q2, s => {
                    licenses = s.docs.map(d => ({id:d.id, ...d.data()}));
                    
                    document.getElementById('stat-licenses').innerText = licenses.length;
                    renderLicenses();
                }, err => showDBError(err, licCont));
                
            } catch (e) {
                showDBError(e, leadsCont);
            }
        }

        function showDBError(error, container) {
            console.error(error);
            if(container) container.innerHTML = `<div class="bg-red-900/30 border border-red-500 text-red-200 p-4 rounded-lg text-xs font-mono">
                <p class="font-bold">ERROR AL LEER DATOS:</p>
                <p>${error.message}</p>
            </div>`;
        }

        window.setInternalTab = (tab) => {
            const w = document.getElementById('view-work');
            const d = document.getElementById('view-data');
            
            if(tab === 'work') {
                if(w) w.classList.remove('hidden');
                if(d) d.classList.add('hidden');
                updateInternalTabStyles('work');
            } else {
                if(w) w.classList.add('hidden');
                if(d) d.classList.remove('hidden');
                updateInternalTabStyles('data');
            }
        };

        function updateInternalTabStyles(activeTab) {
            const appColor = apps[currentAppIndex].color;
            const tabW = document.getElementById('int-tab-work');
            const tabD = document.getElementById('int-tab-data');
            const boxNew = document.getElementById('box-new-lead');
            const btnSave = document.getElementById('btn-save-lead');
            const lblNew = document.getElementById('lbl-new-lead');

            if(activeTab === 'work') {
                if(tabW) tabW.className = `bg-${appColor}-600 text-white p-6 rounded-2xl shadow-lg shadow-${appColor}-900/20 text-left relative overflow-hidden transform scale-[1.02] transition-all border border-${appColor}-400`;
                if(tabD) tabD.className = "bg-slate-800 text-slate-400 p-6 rounded-2xl shadow border border-slate-700 hover:bg-slate-750 hover:text-white transition-all text-left relative overflow-hidden group";
                
                if(boxNew) boxNew.className = `bg-slate-800 border-l-4 border-${appColor}-500 p-6 rounded-r-xl shadow-xl flex flex-col md:flex-row gap-4 items-end transition-colors`;
                if(btnSave) btnSave.className = `w-full md:w-auto bg-${appColor}-600 hover:bg-${appColor}-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform`;
                if(lblNew) lblNew.className = `text-xs font-bold text-${appColor}-400 uppercase mb-2 block flex items-center gap-2`;
            } else {
                if(tabW) tabW.className = "bg-slate-800 text-slate-400 p-6 rounded-2xl shadow border border-slate-700 hover:bg-slate-750 hover:text-white transition-all text-left relative overflow-hidden group";
                if(tabD) tabD.className = "bg-emerald-600 text-white p-6 rounded-2xl shadow-lg shadow-emerald-900/20 text-left border border-emerald-400 relative overflow-hidden transform scale-[1.02] transition-all";
            }
        }

        window.addLead = async () => {
            const input = document.getElementById('input-email');
            const email = input ? input.value.trim().toLowerCase() : '';
            if(!email) return alert("Escribe un correo.");
            try {
                await addDoc(collection(db, 'artifacts', apps[currentAppIndex].id, 'public', 'data', 'krono_leads'), {
                    email: email, status: 'new', createdAt: new Date().toISOString()
                });
                if(input) input.value = "";
            } catch(e) { alert(e.message); }
        };

        window.del = async (col, id, msg) => {
            if(confirm(msg)) await deleteDoc(doc(db, 'artifacts', apps[currentAppIndex].id, 'public', 'data', col, id));
        };

        window.act = async (id, email) => {
             const btn = document.getElementById(`btn-act-${id}`);
             if(btn) { btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; btn.disabled=true; }
             
             const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
             let c = "";
             for(let i=0; i<3; i++) c += chars.charAt(Math.floor(Math.random()*chars.length));
             c += "-";
             for(let i=0; i<3; i++) c += chars.charAt(Math.floor(Math.random()*chars.length));

             try {
                await addDoc(collection(db, 'artifacts', apps[currentAppIndex].id, 'public', 'data', 'access_codes'), {
                    email: email, code: c, active: true, createdAt: new Date().toISOString()
                });
                await updateDoc(doc(db, 'artifacts', apps[currentAppIndex].id, 'public', 'data', 'krono_leads', id), {
                    status: 'done', generatedCode: c
                });
             } catch(e) { alert(e.message); if(btn) btn.disabled=false; }
        };

        function renderLeads() {
            const container = document.getElementById('leads-container');
            if(!container) return;
            const app = apps[currentAppIndex];
            if(leads.length === 0) { 
                container.innerHTML = `<div class="text-center py-16 bg-slate-800/30 rounded-2xl border border-dashed border-slate-700 text-slate-500">No hay correos pendientes en ${app.name}.</div>`; 
                return; 
            }
            container.innerHTML = leads.map(l => {
                const isDone = l.status === 'done';
                const actsDone = `
                    <div class="mt-4 bg-slate-900/50 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-center gap-3 border border-emerald-500/20">
                         <div class="flex items-center gap-3">
                            <span class="text-emerald-500 font-bold text-xs uppercase">Clave:</span>
                            <code class="text-white font-mono text-lg tracking-widest">${l.generatedCode}</code>
                         </div>
                         <a href="mailto:${l.email}?subject=Licencia ${app.name}&body=Hola!%0D%0A%0D%0AAquí tienes tu clave: ${l.generatedCode}" target="_blank" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-xs shadow-lg transition-transform active:scale-95 w-full sm:w-auto text-center"><i class="fas fa-paper-plane mr-2"></i> ENVIAR</a>
                    </div>`;
                const actsPending = `
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
                         <a href="mailto:${l.email}?subject=Pago ${app.name}&body=Hola,%0D%0A%0D%0APrecio: ${app.price}." target="_blank" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-lg font-bold text-xs text-center border border-slate-600 transition-colors"><i class="fas fa-euro-sign text-yellow-400 mr-1"></i> PEDIR PAGO (${app.price})</a>
                         <button id="btn-act-${l.id}" onclick="act('${l.id}','${l.email}')" class="bg-${app.color}-600 hover:bg-${app.color}-500 text-white py-3 rounded-lg font-bold text-xs shadow-lg shadow-${app.color}-900/30 transition-colors"><i class="fas fa-bolt mr-1"></i> GENERAR CLAVE</button>
                    </div>`;
                return `
                <div class="bg-slate-800 p-5 rounded-2xl border border-slate-700 shadow-sm hover:border-slate-600 transition-all group">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full flex items-center justify-center font-bold text-lg ${isDone ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : 'bg-slate-700 text-slate-400'}">${l.email.charAt(0).toUpperCase()}</div>
                            <div>
                                <h3 class="font-bold text-white text-lg">${l.email}</h3>
                                <div class="text-xs text-slate-500 flex items-center gap-2">${new Date(l.createdAt).toLocaleDateString()} ${isDone ? '<span class="text-emerald-500 font-bold">• COMPLETADO</span>' : '<span class="text-yellow-500 font-bold">• PENDIENTE</span>'}</div>
                            </div>
                        </div>
                        <button onclick="del('krono_leads','${l.id}','¿Borrar?')" class="text-slate-600 hover:text-red-500 p-2"><i class="fas fa-trash"></i></button>
                    </div>
                    ${isDone ? actsDone : actsPending}
                </div>`;
            }).join('');
        }

        function renderLicenses() {
             const container = document.getElementById('licenses-container');
             if(!container) return;
             if(licenses.length === 0) { container.innerHTML = `<div class="text-center py-16 opacity-50"><i class="fas fa-database text-4xl text-slate-600 mb-3"></i><p>No hay licencias activas.</p></div>`; return; }
             container.innerHTML = licenses.map(l => `
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center hover:bg-slate-700/50 transition-colors group">
                    <div class="font-bold text-white flex items-center gap-3">${l.email} <code class="text-emerald-400 text-xs font-mono bg-slate-900 px-2 py-1 rounded border border-slate-600 tracking-wider">${l.code}</code></div>
                    <button onclick="del('access_codes','${l.id}','¡PELIGRO! ¿Borrar acceso?')" class="bg-red-500/10 text-red-500 px-3 py-2 rounded-lg text-xs font-bold hover:bg-red-500 hover:text-white transition-colors flex items-center gap-2"><i class="fas fa-trash-alt"></i></button>
                </div>`).join('');
        }

        window.switchApp = switchApp;
        window.setInternalTab = setInternalTab;
        window.addLead = addLead;
        window.del = del;
        window.act = act;
    </script>
</body>
</html>


